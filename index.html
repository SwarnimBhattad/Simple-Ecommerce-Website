<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Tracking Demo – Full E-commerce Flow</title>
    <link rel="stylesheet" href="styles.css">

    <!-- ====================== GOOGLE TAG MANAGER ====================== -->
    <script>(function(w,d,s,l,i){
        w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-N8N8QH73');</script>

    <!-- ====================== gtag.js (GA4) ====================== -->
    <!-- REPLACE G-XXXXXXXXXX WITH YOUR GA4 MEASUREMENT ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23GMWNMGG0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // DEBUG MODE – REMOVE BEFORE PRODUCTION
      gtag('config', 'G-23GMWNMGG0', { debug_mode: true });
    </script>
</head>
<body>

<!-- GTM noscript -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N8N8QH73"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<!-- ====================== LANDING ====================== -->
<div id="landing" class="section">
    <h1 class="main-title">Full E-commerce Tracking Demo</h1>
    <h2 class="welcome-title">Explore Products & Buy</h2>
    <nav>
        <a href="#products">View Products</a>
        <a href="#cart">View Cart</a>
        <a href="#newsletter">Subscribe</a>
    </nav>
</div>

<!-- ====================== PRODUCTS ====================== -->
<div id="products" class="section" style="display:none;">
    <h1>Products</h1>
    <div class="products-grid">

        <!-- Product 1: Oral-Zahnbürste -->
        <div class="item-block" data-product='{
            "item_id":"001","item_name":"Oral-Zahnbürste","item_brand":"Oral-B",
            "item_category":"Hygiene","price":5,"currency":"EUR"
        }'>
            <h3>Oral-Zahnbürste</h3>
            <p class="price">€5</p>
            <p>Oral-B • Blue</p>
        </div>

        <!-- Product 2: Electric Razor (Philips) -->
        <div class="item-block" data-product='{
            "item_id":"002","item_name":"Electric Razor","item_brand":"Philips",
            "item_category":"Personal Care","price":15,"currency":"EUR"
        }'>
            <h3>Electric Razor</h3>
            <p class="price">€15</p>
            <p>Philips • Black</p>
        </div>

        <!-- Product 3: Hair Dryer (Dyson) -->
        <div class="item-block" data-product='{
            "item_id":"003","item_name":"Hair Dryer","item_brand":"Dyson",
            "item_category":"Personal Care","price":10,"currency":"EUR"
        }'>
            <h3>Hair Dryer</h3>
            <p class="price">€10</p>
            <p>Dyson • White</p>
        </div>
    </div>
</div>

<!-- ====================== CART ====================== -->
<div id="cart" class="section" style="display:none;">
    <h1>Your Cart</h1>
    <div id="cart-items" class="cart-container"></div>
    <div id="cart-total" class="cart-total" style="display:none;">
        <h3>Total: €<span id="total-amount">0.00</span></h3>
    </div>
    <button id="proceed-checkout" style="display:none;">Proceed to Checkout</button>
</div>

<!-- ====================== CHECKOUT ====================== -->
<div id="checkout" class="section" style="display:none;">
    <h1>Checkout</h1>
    <div class="checkout-form">
        <input type="text" id="firstName" placeholder="First Name" required>
        <input type="text" id="lastName"  placeholder="Last Name"  required>
        <input type="text" id="country"   placeholder="Country"   required>
        <div id="checkout-total" class="checkout-total">
            Total: €<span id="checkout-total-amount">0.00</span>
        </div>
        <button id="purchase">Finish Purchase</button>
    </div>
</div>

<!-- ====================== NEWSLETTER ====================== -->
<div id="newsletter" class="section" style="display:none;">
    <h1 class="newsletter-title">Subscribe</h1>
    <input type="email" id="newsletter-email" placeholder="Your email">
    <button id="subscribe">Subscribe</button>
</div>

<!-- ====================== THANK YOU ====================== -->
<div id="thankyou" class="section" style="display:none;">
    <h1>Thank You!</h1>
    <div id="order-details" class="order-summary"></div>
</div>

<script>
/* ============================================================== 
   GLOBAL STATE
   ============================================================== */
const cart = [];
const $ = id => document.getElementById(id);

/* ============================================================== 
   NAVIGATION
   ============================================================== */
function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    $(id).style.display='block';
    window.scrollTo({top:0,behavior:'smooth'});
}
function navigateTo(id){
    showSection(id);
    history.pushState({section:id},'', '#'+id);
}
window.addEventListener('popstate', e=>{
    const sec = e.state?.section || 'landing';
    showSection(sec);
});

/* ============================================================== 
   MAIN FUNCTIONAL LOGIC (runs after DOM is ready)
   ============================================================== */
document.addEventListener('DOMContentLoaded', ()=>{

    /* Navigation Links */
    document.querySelectorAll('a[href^="#"]').forEach(a=>{
        a.addEventListener('click', e=>{
            e.preventDefault();
            navigateTo(a.getAttribute('href').slice(1));
        });
    });

    /* 1. view_item_list – when product section is visible */
    const productObserver = new IntersectionObserver(entries=>{
        if(entries[0].isIntersecting){
            const items = Array.from(document.querySelectorAll('.item-block')).map(el=>{
                const p = JSON.parse(el.dataset.product);
                return {
                    item_id: p.item_id,
                    item_name: p.item_name,
                    item_brand: p.item_brand,
                    item_category: p.item_category,
                    price: p.price,
                    quantity: 1
                };
            });

            gtag('event', 'view_item_list', {
                item_list_id: 'main_list',
                item_list_name: 'Main Product List',
                items
            });

            dataLayer.push({ event: 'view_item_list', ecommerce: { items } });
            productObserver.unobserve(entries[0].target);
        }
    }, { threshold: 0.3 });

    const prod = $('#products');
    if(prod) productObserver.observe(prod);

    /* 2. ADD TO CART */
    document.querySelectorAll('.item-block').forEach(block=>{
        block.addEventListener('click', ()=>{
            const p = JSON.parse(block.dataset.product);
            const existing = cart.find(i=>i.item_id===p.item_id);
            const qty = existing ? existing.quantity + 1 : 1;
            if(existing) existing.quantity = qty;
            else cart.push({ ...p, quantity: qty });

            const value = p.price * qty;
            const items = [{ ...p, quantity: qty }];

            gtag('event', 'add_to_cart', { currency: 'EUR', value, items });
            dataLayer.push({ event: 'add_to_cart', ecommerce: { currency:'EUR', value, items } });

            updateCart();
            navigateTo('cart');
        });
    });

    /* 3. CART DISPLAY + view_cart */
    function updateCart(){
        const container = $('#cart-items');
        const totalEl = $('#total-amount');
        const btn = $('#proceed-checkout');

        if(cart.length===0){
            container.innerHTML = '<p class="placeholder">Cart is empty</p>';
            $('#cart-total').style.display='none';
            btn.style.display='none';
            return;
        }

        const total = cart.reduce((s,i)=>s + i.price*i.quantity,0);
        totalEl.textContent = total.toFixed(2);
        $('#checkout-total-amount').textContent = total.toFixed(2);
        $('#cart-total').style.display='block';
        btn.style.display='block';

        container.innerHTML = cart.map(item=>`
            <div class="cart-item">
                <div>
                    <h4>${item.item_name}</h4>
                    <p>€${item.price.toFixed(2)} × ${item.quantity}</p>
                </div>
                <div>
                    <input type="number" min="1" value="${item.quantity}"
                           onchange="updateQty('${item.item_id}',this.value)">
                    <button onclick="removeItem('${item.item_id}')">Remove</button>
                </div>
            </div>`).join('');
    }

    window.updateQty = (id, val)=>{
        const item = cart.find(i=>i.item_id===id);
        if(item) item.quantity = Math.max(1, parseInt(val)||1);
        updateCart();
    };

    window.removeItem = id=>{
        const item = cart.find(i=>i.item_id===id);
        if(!item) return;

        const value = item.price * item.quantity;
        const items = [{ ...item }];

        gtag('event', 'remove_from_cart', { currency: 'EUR', value, items });
        dataLayer.push({ event: 'remove_from_cart', ecommerce: { currency:'EUR', value, items } });

        cart.splice(cart.indexOf(item),1);
        updateCart();

        if(cart.length===0) navigateTo('landing');
    };

    const cartObserver = new IntersectionObserver(entries=>{
        if(entries[0].isIntersecting && cart.length>0){
            const items = cart.map(i=>({...i}));
            const value = cart.reduce((s,i)=>s+i.price*i.quantity,0);

            gtag('event', 'view_cart', { currency: 'EUR', value, items });
            dataLayer.push({ event: 'view_cart', ecommerce: { currency:'EUR', value, items } });
            cartObserver.unobserve(entries[0].target);
        }
    }, { threshold: 0.5 });

    const cartSec = $('#cart');
    if(cartSec) cartObserver.observe(cartSec);

    /* 4. PROCEED TO CHECKOUT → add_shipping_info */
    $('#proceed-checkout').addEventListener('click', ()=>{
        const items = cart.map(i=>({...i}));
        const value = cart.reduce((s,i)=>s+i.price*i.quantity,0);

        gtag('event', 'add_shipping_info', {
            currency: 'EUR',
            value,
            shipping_tier: 'Standard Ground',
            items
        });

        dataLayer.push({
            event: 'add_shipping_info',
            ecommerce: { currency:'EUR', value, shipping_tier:'Standard Ground', items }
        });

        navigateTo('checkout');
    });

    /* 5. PURCHASE */
    $('#purchase').addEventListener('click', ()=>{
        if(!$('#firstName').value || !$('#lastName').value || !$('#country').value){
            alert('Please fill all fields');
            return;
        }

        const transaction_id = 'T_' + Date.now();
        const value = cart.reduce((s,i)=>s+i.price*i.quantity,0);
        const items = cart.map(i=>({...i}));

        gtag('event', 'purchase', {
            transaction_id,
            value,
            tax: 0,
            shipping: 0,
            currency: 'EUR',
            items
        });

        dataLayer.push({
            event: 'purchase',
            ecommerce: { transaction_id, value, currency:'EUR', items }
        });

        $('#order-details').innerHTML = `
            <p><strong>Order:</strong> ${transaction_id}</p>
            <p><strong>Total:</strong> €${value.toFixed(2)}</p>
            <p>Thank you, ${$('#firstName').value}!</p>
        `;

        cart.length = 0;
        updateCart();
        navigateTo('thankyou');
    });

    /* 6. NEWSLETTER */
    $('#subscribe').addEventListener('click', ()=>{
        const email = $('#newsletter-email').value.trim();
        if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
            alert('Valid email required');
            return;
        }
        gtag('event', 'generate_lead', { value:1, currency:'EUR' });
        dataLayer.push({ event: 'newsletter_signup', email });
        $('#newsletter-email').value='';
        alert('Subscribed!');
    });

    /* INIT */
    showSection('landing');
    history.replaceState({section:'landing'},'','#landing');
});
</script>
</body>
</html>
